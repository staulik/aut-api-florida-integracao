name: Allure Tests by Postman

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '30 19 * * MON-FRI'
  workflow_dispatch:

permissions: write-all

jobs:
  automated-api-integracao:
    runs-on: windows-latest
    steps:
      - name: Step 1 - Install dependencies
        uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: |
          npm install -g newman
          npm install -g allure-commandline --save-dev
          npm install -g newman-reporter-allure

      - name: Step 2 - Run POSTMAN collection
        if: always()
        continue-on-error: true
        run: |
          newman run Florida_Release_Notes.postman_collection.json -e CI-test.postman_environment.json -r allure

      - name: Step 3 - Generate Allure report
        run: |
          allure generate ./allure-results -o allure-report/
          
      - name: Step 4 - Add custom executor information to results
        run: |
          allure executors add "Automated API Integration Tests" "Postman"
          allure executors set "Automated API Integration Tests" "Postman" -c 1

      - name: Step 5 - Publish Allure artifact
        uses: actions/upload-artifact@v3
        with:
          name: allure-report
          path: allure-report

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report
          destination_dir: allure-report

      - name: Send mail
        uses: dawidd6/action-send-mail@v3
        with:
          connection_url: ${{ secrets.MAIL_CONNECTION }}
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: Github Actions test job result
          to: sauliktest@gmail.com, silvio.aulik@gmail.com, staulik10@gmail.com, jefferson.barbieri@outtech.com.br, paulo.lima_ext@pernambucanas.com.br
          from: staulik10@gmail.com
          html_body: |
            <p>Build de Teste Realizado ;) Projeto <a href="https://github.com/${{ github.repository }}">Link Projeto</a></p><br>
            <p>Link do Relat√≥rio do Projeto <a href="https://staulik.github.io/aut-api-florida-integracao/allure-report/">Link Report</a></p>
          reply_to: silvio.aulik@gmail.com
          ignore_cert: true
          convert_markdown: true
          priority: normal

